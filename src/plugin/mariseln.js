































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































import yts from 'yt-search';
import ytdl from 'ytdl-core';
import pkg, { prepareWAMessageMedia } from '@whiskeysockets/baileys';
const { generateWAMessageFromContent, proto } = pkg;

// Use a global variable to store the topVideos and video index
const videoMap = new Map();
let videoIndex = 1; // Global index for video links
let audioIndex = 1001; // Separate index for audio links to ensure unique IDs

const song = async (m, Matrix) => {
  const prefixMatch = m.body.match(/^[\\/!#.]/);
  const prefix = prefixMatch ? prefixMatch[0] : '/';
  const cmd = m.body.startsWith(prefix) ? m.body.slice(prefix.length).split(' ')[0].toLowerCase() : '';
  const text = m.body.slice(prefix.length + cmd.length).trim();

  const validCommands = ['yts', 'ytsearch'];

  if (validCommands.includes(cmd)) {
    if (!text) return m.reply('Please provide a YouTube URL or search query');

    try {
      await m.React("ðŸ“¡");

      // Search YouTube for the provided query
      const searchResult = await yts(text);
      const topVideos = searchResult.videos.slice(0, 10);

      if (topVideos.length === 0) {
        m.reply('No results found.');
        await m.React("ðŸ™†â€â™‚ï¸");
        return;
      }

      // Store the videos in the map for later retrieval
      topVideos.forEach((video, index) => {
        videoMap.set(videoIndex + index, { ...video, isAudio: false });
        videoMap.set(audioIndex + index, { ...video, isAudio: true });
      });

      // Send the initial message prompting the user to reply
      const msg = generateWAMessageFromContent(m.from, {
        conversation: `ðŸ” *Top 10 YouTube Results*\n\nPlease reply with:\n*audio* - to download the audio\n*video* - to download the video\n\n${topVideos.map((v, i) => `${i + 1}. ${v.title}`).join('\n')}\n\nPowered by Samsung_MD`,
      }, { quoted: m });

      await Matrix.relayMessage(m.from, msg.message, { messageId: msg.key.id });
      await m.React("ðŸš€");

      // Increment the global indices for future queries
      videoIndex += topVideos.length;
      audioIndex += topVideos.length;

    } catch (error) {
      console.error("Error processing your request:", error);
      m.reply('Error processing your request.');
      await m.React("ðŸ™†â€â™‚ï¸");
    }
  } else {
    // Handle user replies for audio or video download
    const response = m.body.toLowerCase();
    const isAudio = response === 'audio';
    const isVideo = response === 'video';

    if (isAudio || isVideo) {
      const index = parseInt(response === 'audio' ? audioIndex - 10 : videoIndex - 10); // Adjust based on last query
      const selectedVideo = videoMap.get(index);

      if (selectedVideo) {
        try {
          const videoInfo = await ytdl.getBasicInfo(selectedVideo.videoId);
          const title = videoInfo.videoDetails.title;
          const author = videoInfo.videoDetails.author.name;
          const duration = videoInfo.videoDetails.lengthSeconds;
          const uploadDate = videoInfo.videoDetails.uploadDate;
          const videoUrl = `https://www.youtube.com/watch?v=${selectedVideo.videoId}`;
          const thumbnailUrl = selectedVideo.thumbnail;

          if (isAudio) {
            const audioStream = ytdl(videoUrl, { filter: 'audioonly', quality: 'highestaudio' });
            const finalAudioBuffer = await streamToBuffer(audioStream);

            await Matrix.sendMessage(m.from, {
              image: { url: thumbnailUrl },
              caption: `ðŸŽµ *Audio Download*\n\nTitle: ${title}\nAuthor: ${author}\nDuration: ${duration} seconds\n\nPowered by Samsung_MD`,
            }, { quoted: m });

            await Matrix.sendMessage(m.from, {
              audio: finalAudioBuffer,
              mimetype: 'audio/mpeg',
            }, { quoted: m });

          } else if (isVideo) {
            const videoStream = ytdl(videoUrl, { filter: 'audioandvideo', quality: 'highest' });
            const finalVideoBuffer = await streamToBuffer(videoStream);

            await Matrix.sendMessage(m.from, {
              video: finalVideoBuffer,
              mimetype: 'video/mp4',
              caption: `ðŸŽ¥ *Video Download*\n\nTitle: ${title}\nAuthor: ${author}\nDuration: ${duration} seconds\n\nPowered by Samsung_MD`,
            }, { quoted: m });
          }
        } catch (error) {
          console.error("Error fetching video:", error);
          m.reply('Error fetching the requested media.');
        }
      } else {
        m.reply('Invalid response. Please try again.');
      }
    }
  }
};

const streamToBuffer = async (stream) => {
  return new Promise((resolve, reject) => {
    const chunks = [];
    stream.on('data', chunk => chunks.push(chunk));
    stream.on('end', () => resolve(Buffer.concat(chunks)));
    stream.on('error', reject);
  });
};

export default song;

